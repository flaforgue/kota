function Game(t,e){this.stage=new createjs.Stage("kota"),this.background=new createjs.Bitmap("./img/background.png"),this.stage.addChild(this.background),this.isPaused=!1,this.width=t,this.height=e}function ManagementPanel(){ManagementPanel.changeAntActionInterval=null}function Anthill(){this.shape=new createjs.Shape,this.size=40,this.territory={size:100,shape:new createjs.Shape},this.ants=new Array,this.nb_ants_max=100,this.shape.graphics.beginFill("#222").drawCircle(0,0,this.size),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/1.2),this.shape.graphics.beginFill("#333").drawCircle(0,0,this.size/1.3),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/1.6),this.shape.graphics.beginFill("#444").drawCircle(0,0,this.size/1.8),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/2.2),this.shape.graphics.beginFill("#555").drawCircle(0,0,this.size/2.6),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/5);var t,e;do t=Math.ceil(Math.random()*game.width),e=Math.ceil(Math.random()*game.height);while(!game.containsCoordinates(t,e,0));this.shape.x=t,this.shape.y=e,this.territory.shape.x=this.shape.x,this.territory.shape.y=this.shape.y,this.food_stock=0,this.max_food_stock=1e3,this.found_resources=new Array,this.activities_done={waiting:0,exploring:0,collecting:0}}function Ant(t){this.shape=new createjs.Shape,game.stage.addChild(this.shape),this.shape.x=t.shape.x,this.shape.y=t.shape.y,this.anthill=t,this.carrying=!1;var e=ManagementPanel.getDefaultAntAction();this.startAction(e),this.resource_carried=new createjs.Shape}function Resource(t,e){this.life=Math.ceil(50*Math.random()),this.shape=new createjs.Shape,this.shape.x=t,this.shape.y=e,this.shape.graphics.beginFill("#F00").drawCircle(0,0,this.life/2),game.stage.addChild(this.shape)}Game.prototype.createAnthill=function(){this.anthill=new Anthill,this.stage.regX=this.anthill.shape.x-$("#kota").attr("width")/2,this.stage.regY=this.anthill.shape.y-$("#kota").attr("height")/2,this.stage.addChild(this.anthill.shape),this.stage.addChild(this.anthill.territory.shape)},Game.prototype.update=function(){this.isPaused||(this.updateAnts(),this.updateResources(),this.stage.update())},Game.prototype.updateAnts=function(){for(var t=0;t<this.anthill.ants.length;t++)this.anthill.ants[t].update()},Game.prototype.replayGameIfPaused=function(){this.isPaused&&this.replayGame()},Game.prototype.replayGame=function(){this.isPaused=!1},Game.prototype.pauseGame=function(){this.isPaused=!0},Game.prototype.createAnts=function(){this.anthill.canCreateAnt()&&this.anthill.createAnt()},Game.prototype.starvingCheck=function(){this.isPaused||this.anthill.isStarving()&&this.anthill.decreasePopulation()},Game.prototype.makeAntsEat=function(){if(!this.isPaused){var t=this.anthill.getDifficulty(),e=Math.floor(this.anthill.ants.length*t);this.anthill.decreaseFood(e)}},Game.prototype.updateResources=function(){if(this.anthill.found_resources.length>0){var t=0;do resource=this.anthill.found_resources[t],"undefined"!=typeof resource&&(resource.life<=0?(game.stage.removeChild(resource),this.anthill.found_resources.splice(t,1)):t++);while("undefined"!=typeof resource)}},Game.prototype.containsCoordinates=function(t,e,i){return t>i&&t<this.width-i&&e>i&&e<this.height-i},Game.prototype.moveWorldView=function(t,e){var i=10;e||(i*=-1),game.canMoveWorld(t,e)&&(game.stage[t]+=i)},Game.prototype.canMoveWorld=function(t,e){if("regX"==t)var i=game.width-$("#kota").width()+100;else var i=game.height-$("#kota").height()+40;return this.stage[t]>=0&&!e||this.stage[t]<=i&&e},Game.prototype.zoomIn=function(t){game.stage.scaleX<2&&this.updateZoom(game.stage.scaleX+t)},Game.prototype.zoomOut=function(t){game.stage.scaleX>.25&&this.updateZoom(game.stage.scaleX-t)},Game.prototype.updateZoom=function(t){this.stage.scaleX=t,this.stage.scaleY=t},ManagementPanel.startAction=function(t){ManagementPanel.getNbAntsLabelsForAllActions().text("0"),ManagementPanel.getNbAntsLabelForAction(t).text(game.anthill.ants.length);for(var e=0;e<game.anthill.ants.length;e++)game.anthill.ants[e].action!=t&&game.anthill.ants[e].startAction(t)},ManagementPanel.getNbAntsLabelForAction=function(t){return $("#nb-"+t+"-ants")},ManagementPanel.getNbAntsLabelsForAllActions=function(){return $(".action-nb-ants-label")},ManagementPanel.addAntActionButtonHandler=function(t){ManagementPanel.addOrRemoveAntActionButtonHandler(t,!0)},ManagementPanel.removeAntActionButtonHandler=function(t){ManagementPanel.addOrRemoveAntActionButtonHandler(t,!1)},ManagementPanel.addOrRemoveAntActionButtonHandler=function(t,e){ManagementPanel.addOrRemoveAction(t,e),ManagementPanel.changeAntActionInterval=setInterval(function(){ManagementPanel.addOrRemoveAction(t,e)},100,e)},ManagementPanel.addOrRemoveAction=function(t,e){e?ManagementPanel.addAntAction(t):ManagementPanel.removeAntAction(t)},ManagementPanel.addAntAction=function(t){if(game.anthill.hasWaitingAnt()){var e=game.anthill.getWaitingAnt();e.startAction(t),ManagementPanel.updateNbAntsForAction(t),ManagementPanel.updateNbAntsForAction("waiting")}},ManagementPanel.removeAntAction=function(t){if(game.anthill.hasAntOfActivity(t)){var e=game.anthill.getAntOfActivity(t);e.startWaiting(),ManagementPanel.updateNbAntsForAction(t),ManagementPanel.updateNbAntsForAction("waiting")}},ManagementPanel.clearChangeAntActionInterval=function(){clearInterval(ManagementPanel.changeAntActionInterval)},ManagementPanel.getDefaultAntAction=function(){return document.getElementById("default-action").value},ManagementPanel.updateNbAntsBarAndLabel=function(){ManagementPanel.updateResourceBarAndLabel("ants",game.anthill.ants.length,game.anthill.nb_ants_max)},ManagementPanel.updateFoodBarAndLabel=function(){ManagementPanel.updateResourceBarAndLabel("food",game.anthill.food_stock,game.anthill.max_food_stock)},ManagementPanel.updateResourceBarAndLabel=function(t,e,i){var n=e/i*100;document.getElementById(t+"-bar").style.width=n+"%",document.getElementById(t+"-label").innerHTML=e+" / "+i},ManagementPanel.updateNbAntsForAction=function(t){document.getElementById("nb-"+t+"-ants").innerHTML=game.anthill.activities_done[t]},Anthill.prototype.getDifficulty=function(){return.1+.05/Math.floor(this.ants.length)/this.nb_ants_max},Anthill.prototype.canCreateAnt=function(){return this.ants.length<this.nb_ants_max&&this.ants.length<this.food_stock},Anthill.prototype.createAnt=function(){var t=new Ant(this);this.ants.push(t),this.updateTerritory(5)},Anthill.prototype.increaseFood=function(t){this.updateFood(t)},Anthill.prototype.decreaseFood=function(t){this.updateFood(t*-1)},Anthill.prototype.updateFood=function(t){this.food_stock+=t,this.food_stock<0&&(this.food_stock=0),ManagementPanel.updateFoodBarAndLabel()},Anthill.prototype.containsCoordinate=function(t,e){return t>this.shape.x-this.size&&t<this.shape.x+this.size&&e>this.shape.y-this.size&&e<this.shape.y+this.size},Anthill.prototype.isInTerritory=function(t,e){var i=t>this.territory.shape.x-this.territory.size&&t<this.territory.shape.x+this.territory.size;if(i){var n=(t-this.territory.shape.x)/this.territory.size,a=Math.acos(n),o=Math.sin(a)*this.territory.size,s=this.territory.shape.y-o,r=this.territory.shape.y+o,h=e>s&&e<r;return i&&h&&game.containsCoordinates(t,e,0)}return!1},Anthill.prototype.findCollectableResource=function(){for(var t=new Array,e=0;e<this.found_resources.length;e++)this.found_resources[e].life>0&&t.push(this.found_resources[e]);if(0==t.length)return!1;var i=Math.floor(Math.random()*t.length);return t[i]},Anthill.prototype.hasWaitingAnt=function(){return this.hasAntOfActivity("waiting")},Anthill.prototype.hasExploringAnt=function(){return this.hasAntOfActivity("exploring")},Anthill.prototype.hasCollectingAnt=function(){return this.hasAntOfActivity("collecting")},Anthill.prototype.hasAntOfActivity=function(t){return this.activities_done[t]>0},Anthill.prototype.getWaitingAnt=function(){return this.getAntOfActivity("waiting")},Anthill.prototype.getExploringAnt=function(){return this.getAntOfActivity("exploring")},Anthill.prototype.getCollectingAnt=function(){return this.getAntOfActivity("collecting")},Anthill.prototype.getAntOfActivity=function(t){for(var e=0;e<this.ants.length;e++)if(this.ants[e].action==t)return this.ants[e]},Anthill.prototype.isStarving=function(){return this.food_stock<=0},Anthill.prototype.decreasePopulation=function(){if(this.ants.length>1)for(var t=0;t<Math.ceil(this.ants.length/10);t++)this.killAnt(t),this.increaseFood(1)},Anthill.prototype.killAnt=function(t){var e=this.ants[t];"collecting"==e.action&&game.stage.removeChild(e.resource_carried),this.activities_done[e.action]--,ManagementPanel.updateNbAntsForAction(e.action),this.updateTerritory(-5),this.ants.splice(t,1),game.stage.removeChild(e.shape),game.stage.removeChild(e.resource_carried)},Anthill.prototype.updateTerritory=function(t){this.territory.size+=t,this.territory.shape.graphics.clear(),this.territory.shape.graphics.beginFill("rgba(0,170,255,0.2)").drawCircle(0,0,this.territory.size)},Ant.prototype.startAction=function(t){switch(t){case"waiting":this.startWaiting();break;case"exploring":this.startExploring();break;case"collecting":this.startCollecting();break;default:console.log("ERROR : unknown action")}ManagementPanel.updateNbAntsForAction(t)},Ant.prototype.startWaiting=function(t){this.changeActivityTo("waiting"),this.xT=this.anthill.shape.x,this.yT=this.anthill.shape.y},Ant.prototype.startExploring=function(){this.changeActivityTo("exploring"),this.smoothCoordinates(),this.findNewExploringTarget()},Ant.prototype.startCollecting=function(){this.smoothCoordinates(),this.findResourceToCollect(),"collecting"!=this.action&&this.changeActivityTo("collecting")},Ant.prototype.findResourceToCollect=function(){var t=this.anthill.findCollectableResource();0!=t&&(this.collected_resource=t)},Ant.prototype.smoothCoordinates=function(){this.shape.x=Math.ceil(this.shape.x),this.shape.y=Math.ceil(this.shape.y)},Ant.prototype.changeActivityTo=function(t){"collecting"==this.action?game.stage.removeChild(this.resource_carried):"collecting"==t&&game.stage.addChild(this.resource_carried),this.updateAnthillActivitiesDone(!1),this.action=t,this.updateAnthillActivitiesDone(!0),this.shape.graphics.clear(),this.shape.graphics.beginFill(ANT_COLORS[t]).drawCircle(0,0,3)},Ant.prototype.updateAnthillActivitiesDone=function(t){"undefined"!=typeof this.action&&(t?this.anthill.activities_done[this.action]++:this.anthill.activities_done[this.action]--)},Ant.prototype.stopCollecting=function(){this.startWaiting()},Ant.prototype.isNearFromTarget=function(){return this.isNear(this.xT,this.yT)},Ant.prototype.isNearFromAnthill=function(){return this.isNear(this.anthill.shape.x,this.anthill.shape.y)},Ant.prototype.isNear=function(t,e){return 0==Math.abs(this.shape.x-t)&&0==Math.abs(this.shape.y-e)},Ant.prototype.moveToTarget=function(){this.moveTo(this.xT,this.yT)},Ant.prototype.moveToAnthill=function(){this.moveTo(this.anthill.shape.x,this.anthill.shape.y)},Ant.prototype.moveTo=function(t,e){if(this.hasToMove("x",t)&&!this.hasToMove("y",t))this.moveToBy("x",t);else if(this.hasToMove("y",t)&&!this.hasToMove("x",t))this.moveToBy("y",e);else{var i=Math.floor(2*Math.random());i?this.moveToBy("x",t):this.moveToBy("y",e)}},Ant.prototype.hasToMove=function(t,e){return this.shape[t]!=e},Ant.prototype.moveToBy=function(t,e){this.shape[t]<e?this.shape[t]+=1:this.shape[t]>e&&(this.shape[t]-=1)},Ant.prototype.update=function(){switch(this.action){case"waiting":this.updateWaiting();break;case"exploring":this.updateExploring();break;case"collecting":this.updateCollecting();break;default:console.log("ERROR : unknown action")}},Ant.prototype.updateWaiting=function(){!this.isNearFromTarget()&&this.hasTarget()||this.findTargetInAnthill(),this.moveToTarget()},Ant.prototype.findTargetInAnthill=function(){do this.xT=this.anthill.shape.x-this.anthill.size/2+Math.ceil(Math.random()*this.anthill.size),this.yT=this.anthill.shape.y-this.anthill.size/2+Math.ceil(Math.random()*this.anthill.size);while(!this.anthill.containsCoordinate(this.xT,this.yT))},Ant.prototype.updateCollecting=function(){this.hasCollectedResource()?this.collectResourceIfPossible():this.anthill.found_resources.length>0?this.findResourceToCollect():this.actLikeWaitingAnt()},Ant.prototype.collectResourceIfPossible=function(){this.collected_resource.life<=0&&!this.carrying?(delete this.collected_resource,this.findResourceToCollect()):(this.pickOrStoreResource(),this.moveCollecting())},Ant.prototype.actLikeWaitingAnt=function(){this.anthill.containsCoordinate(this.xT,this.yT)||this.forgetTarget(),this.updateWaiting()},Ant.prototype.forgetTarget=function(){delete this.xT,delete this.yT},Ant.prototype.hasCollectedResource=function(){return"undefined"!=typeof this.collected_resource},Ant.prototype.pickOrStoreResource=function(){this.canStoreFood()?this.storeFood():this.canPickResource()&&this.pickResource()},Ant.prototype.moveCollecting=function(){this.carrying?this.moveToAnthill():this.moveTo(this.collected_resource.shape.x,this.collected_resource.shape.y),this.updateResourceCarried()},Ant.prototype.updateResourceCarried=function(){this.resource_carried.x=this.shape.x,this.resource_carried.y=this.shape.y},Ant.prototype.canStoreFood=function(){return this.carrying&&this.isNearFromAnthill()},Ant.prototype.storeFood=function(){this.carrying=!1,game.stage.removeChild(this.resource_carried),this.anthill.food_stock<this.anthill.max_food_stock&&this.anthill.increaseFood(1)},Ant.prototype.canPickResource=function(){return!this.carrying&&this.isNear(this.collected_resource.shape.x,this.collected_resource.shape.y)},Ant.prototype.pickResource=function(){this.collected_resource.life--,this.collected_resource.shape.graphics.clear(),this.collected_resource.life>0&&this.collected_resource.shape.graphics.beginFill("#F00").drawCircle(0,0,this.collected_resource.life/2),this.carrying=!0,game.stage.addChild(this.resource_carried),this.resource_carried.graphics.beginFill("#F00").drawCircle(0,0,2)},Ant.prototype.updateExploring=function(){this.hasTarget()||this.findNewExploringTarget(),this.isNearFromTarget()&&this.findResourceIfPossible(),this.moveToTarget()},Ant.prototype.findResourceIfPossible=function(){this.canFindResource()&&this.hasFoundResource()&&this.saveResource(),this.findNewExploringTarget()},Ant.prototype.hasTarget=function(){return"undefined"!=typeof this.xT&&"undefined"!=typeof this.yT},Ant.prototype.findNewExploringTarget=function(){var t=this.anthill.shape.x-this.anthill.territory.size,e=this.anthill.shape.y-this.anthill.territory.size,i=this.anthill.shape.x+this.anthill.territory.size,n=this.anthill.shape.y+this.anthill.territory.size;do this.xT=Math.ceil(Math.random()*i)+t,this.yT=Math.ceil(Math.random()*n)+e;while(!this.anthill.isInTerritory(this.xT,this.yT,30))},Ant.prototype.canFindResource=function(){return this.anthill.found_resources.length<25},Ant.prototype.hasFoundResource=function(){var t=2*(this.anthill.found_resources.length+1);return Math.ceil(Math.random()*t)==t},Ant.prototype.saveResource=function(){resourceX=Math.ceil(this.xT),resourceY=Math.ceil(this.yT);var t=new Resource(resourceX,resourceY);this.anthill.found_resources.push(t)};var worldMovingInterval,keyMapAttribute={37:"regX",38:"regY",39:"regX",40:"regY"},keyMapPositiveValue={37:!1,38:!1,39:!0,40:!0},ANT_COLORS={waiting:"#621",exploring:"#4949ff",collecting:"#008400"},NB_ANTS_INIT=1,FOOD_INIT=10,game=new Game(2e3,2e3);game.createAnthill();for(var i=0;i<NB_ANTS_INIT;i++)game.anthill.createAnt();ManagementPanel.updateNbAntsForAction("waiting"),ManagementPanel.updateNbAntsBarAndLabel(),game.anthill.updateFood(FOOD_INIT),createjs.Ticker.framerate=100,createjs.Ticker.addEventListener("tick",function(){game.update()}),setInterval(function(){},2e3),setInterval(function(){game.createAnts(),ManagementPanel.updateNbAntsBarAndLabel()},5e3),setInterval(function(){game.starvingCheck(),ManagementPanel.updateNbAntsBarAndLabel()},1e4),$(window).focus(function(){game.replayGameIfPaused()}),$(window).blur(function(){game.pauseGame()}),$(".start-action").click(function(){var t=$(this).data("action");ManagementPanel.startAction(t)}),$(".add-ant-action").mousedown(function(){var t=$(this).data("action");return ManagementPanel.addAntActionButtonHandler(t),!1}),$(".remove-ant-action").mousedown(function(){var t=$(this).data("action");return ManagementPanel.removeAntActionButtonHandler(t),!1}),$(".add-ant-action, .remove-ant-action").mouseup(function(){ManagementPanel.clearChangeAntActionInterval()}),$(window).keydown(function(t){var e=t.which;if(keyMapAttribute.hasOwnProperty(e))return clearInterval(worldMovingInterval),worldMovingInterval=setInterval(function(){game.moveWorldView(keyMapAttribute[e],keyMapPositiveValue[e])},5),t.preventDefault(),t.stopPropagation(),!1}),$(window).keyup(function(t){if(keyMapAttribute.hasOwnProperty(t.which))return clearInterval(worldMovingInterval),t.preventDefault(),t.stopPropagation(),!1}),$(window).on("wheel",function(t){t.originalEvent.wheelDeltaY>0?game.zoomIn(.03):game.zoomOut(.03)}),history.pushState(null,null,location.href),window.onpopstate=function(t){history.go(1)};