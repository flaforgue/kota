function Game(){this.stage=new createjs.Stage("kota"),this.isPaused=!1}function ManagementPanel(){ManagementPanel.changeAntActionInterval=null}function Anthill(){this.shape=new createjs.Shape,this.ants=new Array,this.size=40,this.nb_ants_max=100,this.shape.graphics.beginFill("#222").drawCircle(0,0,this.size),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/1.2),this.shape.graphics.beginFill("#333").drawCircle(0,0,this.size/1.3),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/1.6),this.shape.graphics.beginFill("#444").drawCircle(0,0,this.size/1.8),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/2.2),this.shape.graphics.beginFill("#555").drawCircle(0,0,this.size/2.6),this.shape.graphics.beginFill("#000").drawCircle(0,0,this.size/5);var t,e;do t=Math.ceil(800*Math.random()),e=Math.ceil(600*Math.random());while(!game.containsCoordinates(t,e,this.size));this.shape.x=t,this.shape.y=e,this.food_stock=0,this.max_food_stock=1e3,this.found_resources=new Array,this.activities_done={waiting:0,exploring:0,collecting:0}}function Ant(t){this.shape=new createjs.Shape,game.stage.addChild(this.shape),this.shape.x=t.shape.x,this.shape.y=t.shape.y,this.anthill=t,this.carrying=!1,this.wait_before_finding_resource=500,this.exploring_efficiency=Math.ceil(4*Math.random())+1;var e=ManagementPanel.getDefaultAntAction();this.startAction(e),this.resource_carried=new createjs.Shape}function Resource(t,e){this.life=Math.ceil(50*Math.random()),this.shape=new createjs.Shape,this.shape.x=t,this.shape.y=e,this.shape.graphics.beginFill("#F00").drawCircle(0,0,this.life/2),game.stage.addChild(this.shape)}Game.prototype.createAnthill=function(){this.anthill=new Anthill,this.stage.addChild(this.anthill.shape)},Game.prototype.update=function(){this.isPaused||(this.updateAnts(),this.updateResources(),this.stage.update())},Game.prototype.updateAnts=function(){for(var t=0;t<this.anthill.ants.length;t++)this.anthill.ants[t].update()},Game.prototype.replayGameIfPaused=function(){this.isPaused&&this.replayGame()},Game.prototype.replayGame=function(){this.isPaused=!1},Game.prototype.pauseGame=function(){this.isPaused=!0},Game.prototype.createAnts=function(){this.anthill.canCreateAnt()&&this.anthill.createAnt()},Game.prototype.starvingCheck=function(){this.isPaused||this.anthill.isStarving()&&this.anthill.decreasePopulation()},Game.prototype.makeAntsEat=function(){if(!this.isPaused){var t=this.anthill.getDifficulty(),e=Math.floor(this.anthill.ants.length*t);this.anthill.decreaseFood(e)}},Game.prototype.updateResources=function(){if(this.anthill.found_resources.length>0){var t=0;do resource=this.anthill.found_resources[t],"undefined"!=typeof resource&&(resource.life<=0?(game.stage.removeChild(resource),this.anthill.found_resources.splice(t,1)):t++);while("undefined"!=typeof resource)}},Game.prototype.containsCoordinates=function(t,e,n){return t>n&&t<800-n&&e>n&&e<600-n},ManagementPanel.startAction=function(t){ManagementPanel.getNbAntsLabelsForAllActions().text("0"),ManagementPanel.getNbAntsLabelForAction(t).text(game.anthill.ants.length);for(var e=0;e<game.anthill.ants.length;e++)game.anthill.ants[e].action!=t&&game.anthill.ants[e].startAction(t)},ManagementPanel.getNbAntsLabelForAction=function(t){return $("#nb-"+t+"-ants")},ManagementPanel.getNbAntsLabelsForAllActions=function(){return $(".action-nb-ants-label")},ManagementPanel.addAntActionButtonHandler=function(t){ManagementPanel.addOrRemoveAntActionButtonHandler(t,!0)},ManagementPanel.removeAntActionButtonHandler=function(t){ManagementPanel.addOrRemoveAntActionButtonHandler(t,!1)},ManagementPanel.addOrRemoveAntActionButtonHandler=function(t,e){ManagementPanel.addOrRemoveAction(t,e),ManagementPanel.changeAntActionInterval=setInterval(function(){ManagementPanel.addOrRemoveAction(t,e)},200,e)},ManagementPanel.addOrRemoveAction=function(t,e){e?ManagementPanel.addAntAction(t):ManagementPanel.removeAntAction(t)},ManagementPanel.addAntAction=function(t){if(game.anthill.hasWaitingAnt()){var e=game.anthill.getWaitingAnt();e.startAction(t),ManagementPanel.updateNbAntsForAction(t),ManagementPanel.updateNbAntsForAction("waiting")}},ManagementPanel.removeAntAction=function(t){if(game.anthill.hasAntOfActivity(t)){var e=game.anthill.getAntOfActivity(t);e.startWaiting(),ManagementPanel.updateNbAntsForAction(t),ManagementPanel.updateNbAntsForAction("waiting")}},ManagementPanel.clearChangeAntActionInterval=function(){clearInterval(ManagementPanel.changeAntActionInterval)},ManagementPanel.getDefaultAntAction=function(){return document.getElementById("default-action").value},ManagementPanel.updateNbAntsBarAndLabel=function(){ManagementPanel.updateResourceBarAndLabel("ants",game.anthill.ants.length,game.anthill.nb_ants_max)},ManagementPanel.updateFoodBarAndLabel=function(){ManagementPanel.updateResourceBarAndLabel("food",game.anthill.food_stock,game.anthill.max_food_stock)},ManagementPanel.updateResourceBarAndLabel=function(t,e,n){var i=e/n*100;document.getElementById(t+"-bar").style.width=i+"%",document.getElementById(t+"-label").innerHTML=e+" / "+n},ManagementPanel.updateNbAntsForAction=function(t){document.getElementById("nb-"+t+"-ants").innerHTML=game.anthill.activities_done[t]},Anthill.prototype.getDifficulty=function(){return.1+.05/Math.floor(this.ants.length)/this.nb_ants_max},Anthill.prototype.canCreateAnt=function(){return this.ants.length<this.nb_ants_max&&this.ants.length<this.food_stock},Anthill.prototype.createAnt=function(){var t=new Ant(this);this.ants.push(t)},Anthill.prototype.increaseFood=function(t){this.updateFood(t)},Anthill.prototype.decreaseFood=function(t){this.updateFood(t*-1)},Anthill.prototype.updateFood=function(t){this.food_stock+=t,this.food_stock<0&&(this.food_stock=0),ManagementPanel.updateFoodBarAndLabel()},Anthill.prototype.containsCoordinate=function(t,e){return t>this.shape.x-this.size&&t<this.shape.x+this.size&&e>this.shape.y-this.size&&e<this.shape.y+this.size},Anthill.prototype.findCollectableResource=function(){for(var t=new Array,e=0;e<this.found_resources.length;e++)this.found_resources[e].life>0&&t.push(this.found_resources[e]);if(0==t.length)return!1;var n=Math.floor(Math.random()*t.length);return t[n]},Anthill.prototype.hasWaitingAnt=function(){return this.hasAntOfActivity("waiting")},Anthill.prototype.hasExploringAnt=function(){return this.hasAntOfActivity("exploring")},Anthill.prototype.hasCollectingAnt=function(){return this.hasAntOfActivity("collecting")},Anthill.prototype.hasAntOfActivity=function(t){return this.activities_done[t]>0},Anthill.prototype.getWaitingAnt=function(){return this.getAntOfActivity("waiting")},Anthill.prototype.getExploringAnt=function(){return this.getAntOfActivity("exploring")},Anthill.prototype.getCollectingAnt=function(){return this.getAntOfActivity("collecting")},Anthill.prototype.getAntOfActivity=function(t){for(var e=0;e<this.ants.length;e++)if(this.ants[e].action==t)return this.ants[e]},Anthill.prototype.isStarving=function(){return this.food_stock<=0},Anthill.prototype.decreasePopulation=function(){if(this.ants.length>1)for(var t=0;t<Math.ceil(this.ants.length/10);t++)this.killAnt(t),this.increaseFood(1)},Anthill.prototype.killAnt=function(t){var e=this.ants[t];this.activities_done[e.action]--,ManagementPanel.updateNbAntsForAction(e.action),this.ants.splice(t,1),game.stage.removeChild(e.shape)},Ant.prototype.startAction=function(t){switch(t){case"waiting":this.startWaiting();break;case"exploring":this.startExploring();break;case"collecting":this.startCollecting();break;default:console.log("ERROR : unknown action")}ManagementPanel.updateNbAntsForAction(t)},Ant.prototype.startWaiting=function(t){this.changeActivityTo("waiting"),this.xT=this.anthill.shape.x,this.yT=this.anthill.shape.y},Ant.prototype.startExploring=function(){this.changeActivityTo("exploring"),this.wait_before_finding_resource=500,this.smoothCoordinates()},Ant.prototype.startCollecting=function(){this.smoothCoordinates(),this.findResourceToCollect(),"collecting"!=this.action&&this.changeActivityTo("collecting")},Ant.prototype.findResourceToCollect=function(){var t=this.anthill.findCollectableResource();0!=t&&(this.collected_resource=t)},Ant.prototype.smoothCoordinates=function(){this.shape.x=Math.ceil(this.shape.x),this.shape.y=Math.ceil(this.shape.y)},Ant.prototype.changeActivityTo=function(t){this.updateAnthillActivitiesDone(!1),this.action=t,this.updateAnthillActivitiesDone(!0),this.shape.graphics.clear(),this.shape.graphics.beginFill(ANT_COLORS[t]).drawCircle(0,0,3)},Ant.prototype.updateAnthillActivitiesDone=function(t){"undefined"!=typeof this.action&&(t?this.anthill.activities_done[this.action]++:this.anthill.activities_done[this.action]--)},Ant.prototype.stopCollecting=function(){this.startWaiting()},Ant.prototype.isNearFromTarget=function(){return this.isNear(this.xT,this.yT)},Ant.prototype.isNearFromAnthill=function(){return this.isNear(this.anthill.shape.x,this.anthill.shape.y)},Ant.prototype.isNear=function(t,e){return 0==Math.abs(this.shape.x-t)&&0==Math.abs(this.shape.y-e)},Ant.prototype.moveToTarget=function(){this.moveTo(this.xT,this.yT)},Ant.prototype.moveToAnthill=function(){this.moveTo(this.anthill.shape.x,this.anthill.shape.y)},Ant.prototype.moveTo=function(t,e){this.hasToMove("x",t)?this.moveToBy("x",t):this.moveToBy("y",e)},Ant.prototype.hasToMove=function(t,e){return this.shape[t]!=e},Ant.prototype.moveToBy=function(t,e){this.shape[t]<e?this.shape[t]+=1:this.shape[t]>e&&(this.shape[t]-=1)},Ant.prototype.update=function(){switch(this.action){case"waiting":this.updateWaiting();break;case"exploring":this.updateExploring();break;case"collecting":this.updateCollecting();break;default:console.log("ERROR : unknown action")}},Ant.prototype.updateWaiting=function(){!this.isNearFromTarget()&&this.hasTarget()||this.findTargetInAnthill(),this.moveToTarget()},Ant.prototype.findTargetInAnthill=function(){do this.xT=this.anthill.shape.x-this.anthill.size/2+Math.ceil(Math.random()*this.anthill.size),this.yT=this.anthill.shape.y-this.anthill.size/2+Math.ceil(Math.random()*this.anthill.size);while(!this.anthill.containsCoordinate(this.xT,this.yT))},Ant.prototype.updateCollecting=function(){this.hasCollectedResource()?this.collectResourceIfPossible():this.anthill.found_resources.length>0?this.findResourceToCollect():this.actLikeWaitingAnt()},Ant.prototype.collectResourceIfPossible=function(){this.collected_resource.life<=0&&!this.carrying?(delete this.collected_resource,this.findResourceToCollect()):(this.pickOrStoreResource(),this.moveCollecting())},Ant.prototype.actLikeWaitingAnt=function(){this.anthill.containsCoordinate(this.xT,this.yT)||this.forgetTarget(),this.updateWaiting()},Ant.prototype.forgetTarget=function(){delete this.xT,delete this.yT},Ant.prototype.hasCollectedResource=function(){return"undefined"!=typeof this.collected_resource},Ant.prototype.pickOrStoreResource=function(){this.canStoreFood()?this.storeFood():this.canPickResource()&&this.pickResource()},Ant.prototype.moveCollecting=function(){this.carrying?this.moveToAnthill():this.moveTo(this.collected_resource.shape.x,this.collected_resource.shape.y),this.updateResourceCarried()},Ant.prototype.updateResourceCarried=function(){this.resource_carried.x=this.shape.x,this.resource_carried.y=this.shape.y},Ant.prototype.canStoreFood=function(){return this.carrying&&this.isNearFromAnthill()},Ant.prototype.storeFood=function(){this.carrying=!1,game.stage.removeChild(this.resource_carried),this.anthill.food_stock<this.anthill.max_food_stock&&this.anthill.increaseFood(1)},Ant.prototype.canPickResource=function(){return!this.carrying&&this.isNear(this.collected_resource.shape.x,this.collected_resource.shape.y)},Ant.prototype.pickResource=function(){this.collected_resource.life--,this.collected_resource.shape.graphics.clear(),this.collected_resource.life>0&&this.collected_resource.shape.graphics.beginFill("#F00").drawCircle(0,0,this.collected_resource.life/2),this.carrying=!0,game.stage.addChild(this.resource_carried),this.resource_carried.graphics.beginFill("#F00").drawCircle(0,0,2)},Ant.prototype.updateExploring=function(){this.wait_before_finding_resource>0&&this.wait_before_finding_resource--,this.hasTarget()||this.findNewExploringTarget(),this.isNearFromTarget()&&this.findResourceIfPossible(),this.moveToTarget()},Ant.prototype.findResourceIfPossible=function(){this.canFindResource()&&this.hasFoundResource()&&(this.wait_before_finding_resource=500,this.saveResource()),this.findNewExploringTarget()},Ant.prototype.hasTarget=function(){return"undefined"!=typeof this.xT&&"undefined"!=typeof this.yT},Ant.prototype.findNewExploringTarget=function(){do this.xT=Math.ceil(800*Math.random()),this.yT=Math.ceil(600*Math.random());while(!game.containsCoordinates(this.xT,this.yT,0))},Ant.prototype.canFindResource=function(){return this.wait_before_finding_resource<=0&&this.anthill.found_resources.length<25},Ant.prototype.hasFoundResource=function(){var t=6-this.exploring_efficiency+2*this.anthill.found_resources.length;return Math.ceil(Math.random()*t*2)==2*t},Ant.prototype.saveResource=function(){resourceX=Math.ceil(this.xT),resourceY=Math.ceil(this.yT);var t=new Resource(resourceX,resourceY);this.anthill.found_resources.push(t)};var ANT_COLORS={waiting:"#621",exploring:"#4949ff",collecting:"#008400"},NB_ANTS_INIT=10,FOOD_INIT=1,game=new Game;game.createAnthill();for(var i=0;i<NB_ANTS_INIT;i++)game.anthill.createAnt();ManagementPanel.updateNbAntsForAction("waiting"),ManagementPanel.updateNbAntsBarAndLabel(),game.anthill.updateFood(FOOD_INIT),createjs.Ticker.framerate=100,createjs.Ticker.addEventListener("tick",function(){game.update()}),setInterval(function(){game.makeAntsEat()},2e3),setInterval(function(){game.createAnts(),ManagementPanel.updateNbAntsBarAndLabel()},5e3),setInterval(function(){game.starvingCheck(),ManagementPanel.updateNbAntsBarAndLabel()},1e4),$(window).focus(function(){game.replayGameIfPaused()}),$(window).blur(function(){game.pauseGame()}),$(".start-action").click(function(){var t=$(this).data("action");ManagementPanel.startAction(t)}),$(".add-ant-action").mousedown(function(){var t=$(this).data("action");return ManagementPanel.addAntActionButtonHandler(t),!1}),$(".remove-ant-action").mousedown(function(){var t=$(this).data("action");return ManagementPanel.removeAntActionButtonHandler(t),!1}),$(".add-ant-action, .remove-ant-action").mouseup(function(){ManagementPanel.clearChangeAntActionInterval()});