function Game(){this.stage=new createjs.Stage("kota"),this.isPaused=!1}function ManagementPanel(){ManagementPanel.changeAntActionInterval=null}function Anthill(){this.shape=new createjs.Shape,this.ants=new Array,this.size=40,this.nb_ants_max=100,this.shape.graphics.beginFill("#666").drawCircle(0,0,this.size),this.shape.graphics.beginFill("#000").drawCircle(0,0,20);var t,e;do t=Math.ceil(800*Math.random()),e=Math.ceil(600*Math.random());while(!game.containsCoordinates(t,e,this.size));this.shape.x=t,this.shape.y=e,this.food_stock=0,this.max_food_stock=1e3,this.found_resources=new Array,this.activities_done={waiting:0,exploring:0,collecting:0}}function Ant(t){this.shape=new createjs.Shape,this.shape.x=t.shape.x,this.shape.y=t.shape.y,this.anthill=t,this.go_to_wild=!0,this.wait_before_finding_resource=500,this.exploring_efficiency=Math.ceil(4*Math.random())+1;var e=ManagementPanel.getDefaultAntAction();this.startAction(e)}function Resource(t,e){this.life=Math.ceil(50*Math.random()),this.shape=new createjs.Shape,this.shape.x=t,this.shape.y=e,this.shape.graphics.beginFill("#F00").drawCircle(0,0,this.life/2),game.stage.addChild(this.shape)}Game.prototype.createAnthill=function(){this.anthill=new Anthill,this.stage.addChild(this.anthill.shape)},Game.prototype.update=function(){this.isPaused||(this.updateAnts(),this.updateResources(),this.stage.update())},Game.prototype.updateAnts=function(){for(var t=0;t<this.anthill.ants.length;t++)this.anthill.ants[t].update()},Game.prototype.replayGameIfPaused=function(){this.isPaused&&this.replayGame()},Game.prototype.replayGame=function(){this.isPaused=!1},Game.prototype.pauseGame=function(){this.isPaused=!0},Game.prototype.createAnts=function(){this.anthill.ants.length<this.anthill.nb_ants_max&&this.anthill.ants.length<this.anthill.food_stock&&this.anthill.createAnt()},Game.prototype.starvingCheck=function(){this.isPaused||this.anthill.isStarving()&&this.anthill.decreasePopulation()},Game.prototype.makeAntsEat=function(){if(!this.isPaused){var t=.1+.05/Math.floor(this.anthill.ants.length)/this.anthill.nb_ants_max,e=Math.floor(this.anthill.ants.length*t);this.anthill.decreaseFood(e)}},Game.prototype.updateResources=function(){if(this.anthill.found_resources.length>0){var t=0;do resource=this.anthill.found_resources[t],"undefined"!=typeof resource&&(resource.life<=0?this.anthill.found_resources.splice(t,1):t++);while("undefined"!=typeof resource)}},Game.prototype.containsCoordinates=function(t,e,n){return t>n&&t<800-n&&e>n&&e<600-n},ManagementPanel.startAction=function(t){ManagementPanel.getNbAntsLabelsForAllActions().text("0"),ManagementPanel.getNbAntsLabelForAction(t).text(game.anthill.ants.length);for(var e=0;e<game.anthill.ants.length;e++)game.anthill.ants[e].action!=t&&game.anthill.ants[e].startAction(t)},ManagementPanel.getNbAntsLabelForAction=function(t){return $("#nb-"+t+"-ants")},ManagementPanel.getNbAntsLabelsForAllActions=function(){return $(".action-nb-ants-label")},ManagementPanel.addAntActionButtonHandler=function(t){ManagementPanel.addOrRemoveAntActionButtonHandler(t,!0)},ManagementPanel.removeAntActionButtonHandler=function(t){ManagementPanel.addOrRemoveAntActionButtonHandler(t,!1)},ManagementPanel.addOrRemoveAntActionButtonHandler=function(t,e){ManagementPanel.addOrRemoveAction(t,e),ManagementPanel.changeAntActionInterval=setInterval(function(){ManagementPanel.addOrRemoveAction(t,e)},200,e)},ManagementPanel.addOrRemoveAction=function(t,e){e?ManagementPanel.addAntAction(t):ManagementPanel.removeAntAction(t)},ManagementPanel.addAntAction=function(t){if(game.anthill.hasWaitingAnt()){var e=game.anthill.getWaitingAnt();e.startAction(t),ManagementPanel.getNbAntsLabelForAction("waiting").text(game.anthill.activities_done.waiting),ManagementPanel.getNbAntsLabelForAction(t).text(game.anthill.activities_done[t])}},ManagementPanel.removeAntAction=function(t){if(game.anthill.hasAntOfActivity(t)){var e=game.anthill.getAntOfActivity(t);e.startWaiting(),ManagementPanel.getNbAntsLabelForAction("waiting").text(game.anthill.activities_done.waiting),ManagementPanel.getNbAntsLabelForAction(t).text(game.anthill.activities_done[t])}},ManagementPanel.clearChangeAntActionInterval=function(){clearInterval(ManagementPanel.changeAntActionInterval)},ManagementPanel.getDefaultAntAction=function(){return document.getElementById("default-action").value},ManagementPanel.updateNbAntsBarAndLabel=function(){ManagementPanel.updateResourceBarAndLabel("ants",game.anthill.ants.length,game.anthill.nb_ants_max)},ManagementPanel.updateFoodBarAndLabel=function(){ManagementPanel.updateResourceBarAndLabel("food",game.anthill.food_stock,game.anthill.max_food_stock)},ManagementPanel.updateResourceBarAndLabel=function(t,e,n){var i=e/n*100;document.getElementById(t+"-bar").style.width=i+"%",document.getElementById(t+"-label").innerHTML=e+" / "+n},ManagementPanel.updateNbAntsForAction=function(t){document.getElementById("nb-"+t+"-ants").innerHTML=game.anthill.activities_done[t]},Anthill.prototype.createAnt=function(){var t=new Ant(this);this.ants.push(t),game.stage.addChild(t.shape)},Anthill.prototype.increaseFood=function(t){this.updateFood(t)},Anthill.prototype.decreaseFood=function(t){this.updateFood(t*-1)},Anthill.prototype.updateFood=function(t){this.food_stock+=t,this.food_stock<0&&(this.food_stock=0),ManagementPanel.updateFoodBarAndLabel()},Anthill.prototype.containsCoordinate=function(t,e){return t>this.shape.x-this.size&&t<this.shape.x+this.size&&e>this.shape.y-this.size&&e<this.shape.y+this.size},Anthill.prototype.findCollectableResource=function(){for(var t=new Array,e=0;e<this.found_resources.length;e++)this.found_resources[e].life>0&&t.push(this.found_resources[e]);return 0!=t.length&&t[Math.ceil(Math.random()*(t.length-1))]},Anthill.prototype.hasWaitingAnt=function(){return this.hasAntOfActivity("waiting")},Anthill.prototype.hasExploringAnt=function(){return this.hasAntOfActivity("exploring")},Anthill.prototype.hasCollectingAnt=function(){return this.hasAntOfActivity("collecting")},Anthill.prototype.hasAntOfActivity=function(t){return this.activities_done[t]>0},Anthill.prototype.getWaitingAnt=function(){return this.getAntOfActivity("waiting")},Anthill.prototype.getExploringAnt=function(){return this.getAntOfActivity("exploring")},Anthill.prototype.getCollectingAnt=function(){return this.getAntOfActivity("collecting")},Anthill.prototype.getAntOfActivity=function(t){for(var e=0;e<this.ants.length;e++)if(this.ants[e].action==t)return this.ants[e]},Anthill.prototype.isStarving=function(){return this.food_stock<=0},Anthill.prototype.decreasePopulation=function(){if(this.ants.length>1)for(var t=0;t<Math.ceil(this.ants.length/10);t++)this.killAnt(t),this.increaseFood(1)},Anthill.prototype.killAnt=function(t){var e=this.ants[t];this.activities_done[e.action]--,ManagementPanel.updateNbAntsForAction(e.action),this.ants.splice(t,1),game.stage.removeChild(e.shape)},Ant.prototype.startAction=function(t){switch(t){case"waiting":this.startWaiting();break;case"exploring":this.startExploring();break;case"collecting":this.startCollecting();break;default:console.log("ERROR : unknown action")}ManagementPanel.updateNbAntsForAction(t)},Ant.prototype.stopCollecting=function(){this.startWaiting()},Ant.prototype.startWaiting=function(t){"undefined"!=typeof this.action&&this.anthill.activities_done[this.action]--,this.action="waiting",this.anthill.activities_done.waiting++,this.xT=this.anthill.shape.x,this.yT=this.anthill.shape.y,this.shape.graphics.clear(),this.shape.graphics.beginFill("#621").drawCircle(0,0,3)},Ant.prototype.startCollecting=function(){this.shape.x=Math.ceil(this.shape.x),this.shape.y=Math.ceil(this.shape.y);var t=this.anthill.findCollectableResource();0!=t&&(this.collected_resource=t),"collecting"!=this.action&&("undefined"!=typeof this.action&&this.anthill.activities_done[this.action]--,this.anthill.activities_done.collecting++,this.shape.graphics.clear(),this.shape.graphics.beginFill("#008400").drawCircle(0,0,3),this.action="collecting")},Ant.prototype.startExploring=function(){"undefined"!=typeof this.action&&this.anthill.activities_done[this.action]--,this.wait_before_finding_resource=500,this.shape.x=Math.ceil(this.shape.x),this.shape.y=Math.ceil(this.shape.y),this.action="exploring",this.anthill.activities_done.exploring++,this.shape.graphics.clear(),this.shape.graphics.beginFill("#4949ff").drawCircle(0,0,3)},Ant.prototype.isNearFromTarget=function(){return this.isNear(this.xT,this.yT)},Ant.prototype.isNearFromAnthill=function(){return this.isNear(this.anthill.shape.x,this.anthill.shape.y)},Ant.prototype.isNear=function(t,e){return Math.abs(this.shape.x-t)<2&&Math.abs(this.shape.y-e)<2},Ant.prototype.moveToTarget=function(){this.moveTo(this.xT,this.yT)},Ant.prototype.moveToAnthill=function(){this.moveTo(this.anthill.shape.x,this.anthill.shape.y)},Ant.prototype.moveTo=function(t,e){this.shape.x<t?this.shape.x+=1:this.shape.x>t?this.shape.x-=1:this.shape.y<e?this.shape.y+=1:this.shape.y>e&&(this.shape.y-=1)},Ant.prototype.update=function(){switch(this.action){case"waiting":this.updateWaiting();break;case"exploring":this.updateExploring();break;case"collecting":this.updateCollecting();break;default:console.log("ERROR : unknown action")}},Ant.prototype.updateWaiting=function(){if(this.isNearFromTarget()||!this.hasTarget()){var t;do targetX=this.anthill.shape.x-this.anthill.size/2+Math.ceil(Math.random()*this.anthill.size),t=this.anthill.shape.y-this.anthill.size/2+Math.ceil(Math.random()*this.anthill.size);while(!this.anthill.containsCoordinate(targetX,t));this.xT=targetX,this.yT=t}this.moveToTarget()},Ant.prototype.updateCollecting=function(){"undefined"!=typeof this.collected_resource?this.collected_resource.life<=0?(delete this.collected_resource,this.startCollecting()):(this.updateCollectingDirection(),this.moveCollecting()):this.anthill.found_resources.length>0?this.startCollecting():(this.anthill.containsCoordinate(this.xT,this.yT)||(this.xT=this.anthill.shape.x,this.yT=this.anthill.shape.y),this.updateWaiting())},Ant.prototype.updateCollectingDirection=function(){this.canStoreFood()?this.storeFood():this.canPickResource()&&this.pickResource()},Ant.prototype.canStoreFood=function(){return!this.go_to_wild&&this.isNearFromAnthill()},Ant.prototype.canPickResource=function(){return this.go_to_wild&&this.isNear(this.collected_resource.shape.x,this.collected_resource.shape.y)},Ant.prototype.pickResource=function(){this.collected_resource.life--,this.collected_resource.shape.graphics.clear(),this.collected_resource.life>0&&this.collected_resource.shape.graphics.beginFill("#F00").drawCircle(0,0,this.collected_resource.life/2),this.go_to_wild=!1},Ant.prototype.storeFood=function(){this.go_to_wild=!0,this.anthill.food_stock<this.anthill.max_food_stock&&this.anthill.increaseFood(1)},Ant.prototype.moveCollecting=function(){this.go_to_wild?this.moveTo(this.collected_resource.shape.x,this.collected_resource.shape.y):this.moveToAnthill()},Ant.prototype.updateExploring=function(){this.wait_before_finding_resource>0&&this.wait_before_finding_resource--,this.hasTarget()||this.findNewTarget(),this.isNearFromTarget()&&(this.canFindResource()&&this.hasFoundResource()&&(this.wait_before_finding_resource=500,this.saveResource()),this.findNewTarget()),this.moveToTarget()},Ant.prototype.canFindResource=function(){return this.wait_before_finding_resource<=0&&this.anthill.found_resources.length<25},Ant.prototype.hasFoundResource=function(){var t=6-this.exploring_efficiency+2*this.anthill.found_resources.length;return Math.ceil(Math.random()*t*2)==2*t},Ant.prototype.saveResource=function(){resourceX=Math.ceil(this.xT),resourceY=Math.ceil(this.yT);var t=new Resource(resourceX,resourceY);this.anthill.found_resources.push(t)},Ant.prototype.hasTarget=function(){return"undefined"!=typeof this.xT&&"undefined"!=typeof this.yT},Ant.prototype.findNewTarget=function(){var t;do targetX=Math.ceil(800*Math.random()),t=Math.ceil(600*Math.random());while(!game.containsCoordinates(targetX,t,0));this.xT=targetX,this.yT=t};var NB_ANTS_INIT=10,game=new Game;game.createAnthill();for(var i=0;i<NB_ANTS_INIT;i++)game.anthill.createAnt();createjs.Ticker.framerate=100,createjs.Ticker.addEventListener("tick",function(){game.update()}),game.anthill.updateFood(0),setInterval(function(){game.makeAntsEat()},2e3),setInterval(function(){game.createAnts(),ManagementPanel.updateNbAntsBarAndLabel()},5e3),setInterval(function(){game.starvingCheck(),ManagementPanel.updateNbAntsBarAndLabel()},1e4),$(window).focus(function(){game.replayGameIfPaused()}),$(window).blur(function(){game.pauseGame()}),ManagementPanel.getNbAntsLabelForAction("waiting").text(game.anthill.activities_done.waiting),ManagementPanel.updateNbAntsBarAndLabel(),$(".start-action").click(function(){var t=$(this).data("action");ManagementPanel.startAction(t)}),$(".add-ant-action").mousedown(function(){var t=$(this).data("action");return ManagementPanel.addAntActionButtonHandler(t),!1}),$(".remove-ant-action").mousedown(function(){var t=$(this).data("action");return ManagementPanel.removeAntActionButtonHandler(t),!1}),$(".add-ant-action, .remove-ant-action").mouseup(function(){ManagementPanel.clearChangeAntActionInterval()});