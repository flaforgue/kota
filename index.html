<!DOCTYPE html>
<html>
<head>
	<title>Kota</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./css/style.css">

	<script type="text/javascript" src="./js/easeljs-0.8.2.min.js"></script>
</head>
<body onload="init();">
	<aside id="terminal">
		<br>
		<table id="control-panel">
			<thead>
				<tr>
					<th>Fourmis</th>
					<th>Nourriture</th>
				</tr>
			</thead>

			<tbody>
				<tr>
					<td id="nb-ants"></td>
					<td id="food-stock"></td>
				</tr>
			</tbody>
		</table>


		<br>
		<table id="control-panel">
			<thead>
				<tr>
					<th>Action</th>
					<th>Fourmis</th>
					<th>Focus</th>
				</tr>
			</thead>

			<tbody>
				<tr id="waiting">
					<td class="action">Waiting</td>
					<td>
						<span id="nb-waiting-ants">0</span>
					</td>
					<td><button id="start-waiting" class="btn">!</button></td>
				</tr>
				
				<tr id="exploring">
					<td class="action">Exploring</td>
					<td class="nb_ants">
						<button id="remove-exploring-ant" class="btn">-</button>
						<span id="nb-exploring-ants">0</span>
						<button id="add-exploring-ant" class="btn">+</button>
					</td>
					<td><button id="start-exploring" class="btn">!</button></td>
				</tr>

				<tr id="collecting">
					<td class="action">Collecting</td>
					<td>
						<button id="remove-collecting-ant" class="btn">-</button>
						<span id="nb-collecting-ants">0</span>
						<button id="add-collecting-ant" class="btn">+</button>
					</td>
					<td><button id="start-collecting" class="btn">!</button></td>
				</tr>
			</tbody>
		</table>

		<br>

		<div class="padding">Action par d√©faut des nouvelles fourmis :
			<select id="default-action">
				<option value="waiting">Waiting</option>
				<option value="exploring">Exploring</option>
				<option value="collecting">Collecting</option>
			</select>
		</div>

		<div id="dialog"></div>
	</aside>

  	<canvas id="kota" width="800" height="600"></canvas>

  	<script>
  		var NB_ANTS_INIT = 1;

  		function terminal(toDisplay) {
  			if (typeof toDisplay == "object") {
  				document.getElementById('dialog').innerHTML += JSON.stringify(toDisplay, null, 4);
  			} else {
  				document.getElementById('dialog').innerHTML += toDisplay;
  			}

  			document.getElementById('dialog').innerHTML += " ";
  		}

	  	function init() {
	  		stage = new createjs.Stage("kota");
		  	anthill = new createjs.Shape();
		  	anthill.ants = new Array;
		  	anthill.size = 40;
		  	anthill.nb_ants_max = 100;
			anthill.graphics.beginFill("#666").drawCircle(0, 0, anthill.size);
			anthill.graphics.beginFill("#000").drawCircle(0, 0, 20);
			var anthillX, anthillY;
    		do {
    			anthillX = Math.ceil(Math.random() * 800);
    			anthillY = Math.ceil(Math.random() * 600);
    		} while (! isInGround(anthillX, anthillY, 40));
    		anthill.x = anthillX;
	    	anthill.y = anthillY;
			anthill.food_stock = 0;
			anthill.max_food_stock = 1000;
			anthill.found_resources = new Array;
			anthill.activities_done = {
				'waiting': 0,
				'exploring': 0,
				'collecting': 0,
			};

			stage.addChild(anthill);

			for (var i = 0; i < NB_ANTS_INIT ; i ++)
				initAnt();

			createjs.Ticker.framerate = 100;
			createjs.Ticker.addEventListener("tick", updateGame);

			document.getElementById('nb-ants').innerHTML = anthill.ants.length;
			document.getElementById('food-stock').innerHTML = anthill.food_stock + '/' + anthill.max_food_stock;
	  	}

	  	function updateGame() {
	  		updateAnts();
	  		updateResources();
	  		stage.update();
	    }

	    function updateResources() {
	    	if (anthill.found_resources.length > 0) {
	    		var i = 0;
		    	do {
		    		resource = anthill.found_resources[i];
		    		if (typeof resource != "undefined") {
			    		if (resource.life <= 0) {
			    			anthill.found_resources.splice(i, 1);
			    		} else {
			    			i ++;
			    		}
			    	}
		    	} while (typeof resource != "undefined")
	    	}
	    }

	    setInterval(createAnts, 5000);

	    function createAnts() {
	    	if (anthill.ants.length < anthill.nb_ants_max && anthill.ants.length < anthill.food_stock) {
	    		initAnt()
		    }
	    }

	    function initAnt() {
	    	var newAnt = new createjs.Shape();
	    	newAnt.tick = 10;
			newAnt.x = anthill.x;
			newAnt.y = anthill.y;
			newAnt.go_to_wild = true;
			newAnt.wait_before_finding_resource = 500;
			newAnt.exploring_efficiency = Math.ceil(Math.random() * 4) + 1;
			terminal(newAnt.exploring_efficiency);
			defaultAntAction(newAnt);
			anthill.ants.push(newAnt);

			newAnt.graphics.beginFill("#621").drawCircle(0, 0, 3);
			stage.addChild(newAnt);

			document.getElementById('nb-ants').innerHTML = anthill.ants.length;
	    }

	    function defaultAntAction(ant) {
	    	var defaultAction = document.getElementById('default-action').value;
	    	switch (defaultAction) {
	    		case 'waiting' :
	    			startWaiting(ant);
	    			break;
	    		case 'exploring' :
	    			startExploring(ant);
	    			break;
	    		case 'collecting' :
	    			startCollecting(ant);
	    			break;
	    	}
	    }

	    function updateAnts() {
		    for (var i = 0 ; i < anthill.ants.length ; i ++) {
		    	updateAnt(anthill.ants[i]);
		    }
	    }

	    function updateAnt(ant) {
	    	switch (ant.action) {
	    		case 'waiting' :
	    			updateWaiting(ant);
	    			break;
	    		case 'collecting' :
		    		updateCollecting(ant);
		    		break;
		    	case 'exploring' :
		    		updateExploring(ant);
		    		break;
	    	}
	    }

	    function updateExploring(ant) {
	    	if (ant.wait_before_finding_resource > 0) {
	    		ant.wait_before_finding_resource --;
	    	}
	    	if (isNear(ant.x, ant.y, ant.xT, ant.yT) || ! hasTarget(ant)) {
	    		if (ant.wait_before_finding_resource <= 0 && anthill.found_resources.length < 25 && findResource(ant)) {
	    			ant.wait_before_finding_resource = 500;
					saveResource(ant.xT, ant.yT);
				}
	    		var tagetX, targetY;
	    		do {
	    			targetX = Math.ceil(Math.random() * 800);
	    			targetY = Math.ceil(Math.random() * 600);
	    		} while (! isInGround(targetX, targetY, 0));
	    		ant.xT = targetX;
		    	ant.yT = targetY;
	    	}

			moveToTarget(ant, ant.xT, ant.yT);
	    }

	    function findResource(ant) {
	    	var chances = 6 - ant.exploring_efficiency;
	    	return Math.ceil(Math.random() * chances * 2) == chances * 2;
	    }

	    function hasTarget(ant) {
	    	return typeof ant.xT != "undefined" && typeof ant.yT != "undefined";
	    }

	    function isInGround(x, y, offset) {
	    	return x > offset && x < (800 - offset) && y > offset && y < (600 - offset);
	    }

	    function updateWaiting(ant) {
			if (isNear(ant.x, ant.y, ant.xT, ant.yT) || ! hasTarget(ant)) {
	    		var tagetX, targetY;
	    		do {
	    			targetX = (anthill.x - anthill.size/2) + Math.ceil(Math.random() * anthill.size);
	    			targetY = (anthill.y - anthill.size/2) + Math.ceil(Math.random() * anthill.size);
	    		} while (! isInAnthill(targetX, targetY));
	    		ant.xT = targetX;
		    	ant.yT = targetY;
	    	}

			moveToTarget(ant, ant.xT, ant.yT);
	    }

	    function isInAnthill(x, y) {
	    	return x > (anthill.x - anthill.size)
	    	&& x < (anthill.x) + anthill.size
	    	&& y > (anthill.y) - anthill.size
	    	&& y < (anthill.y) + anthill.size;
	    }

	    function updateCollecting(ant) {
	    	if (typeof ant.collected_resource != "undefined") {
		    	if (ant.collected_resource.life <= 0) {
		    		delete ant.collected_resource;
		    		ant.go_to_wild = false;
			    	startCollecting(ant);
				} else {
					updateCollectingAntDirection(ant);	
					moveCollectingAnt(ant);
				}
			} else if (anthill.found_resources.length > 0) {
				startCollecting(ant);
			} else {
				if (! isInAnthill(ant.xT, ant.yT)) {
					ant.xT = anthill.x;
					ant.yT = anthill.y;
				}
				updateWaiting(ant);
			}
	    }

	    function updateCollectingAntDirection(ant) {
	    	if (! ant.go_to_wild && isNear(ant.x, ant.y, anthill.x, anthill.y)) {
				stockResource(ant);
			} else if (ant.go_to_wild && isNear(ant.x, ant.y, ant.collected_resource.x, ant.collected_resource.y)) {
				pickResource(ant);
			}
	    }

	    function pickResource(ant) {
			ant.collected_resource.life --;
			ant.collected_resource.graphics.clear();
			
			if (ant.collected_resource.life > 0)
				ant.collected_resource.graphics.beginFill("#F00").drawCircle(0, 0, ant.collected_resource.life/2);
	    	
	    	ant.go_to_wild = false;
	    }

	    function stockResource(ant) {
	    	ant.go_to_wild = true;
	    	if (anthill.food_stock < anthill.max_food_stock) {
				anthill.food_stock ++;
				document.getElementById('food-stock').innerHTML = anthill.food_stock + ' / ' + anthill.max_food_stock;
	    	}
	    }

	    function moveCollectingAnt(ant) {
	    	if (ant.go_to_wild)
				moveToTarget(ant, ant.collected_resource.x, ant.collected_resource.y);
			else
				moveToTarget(ant, anthill.x, anthill.y)
	    }

	    function isNear(x, y, xT, yT) {
	    	return (Math.abs(x - xT) < 2) && (Math.abs(y - yT) < 2)
	    }

	    function startCollecting(ant) {
	    	ant.x = Math.ceil(ant.x);
	    	ant.y = Math.ceil(ant.y);
	    	var resource = findResourceToCollect();
	    	if (resource != false) {
			    ant.tick = 0;
			    ant.collected_resource = resource;
	    	}
	    	if (ant.action != "collecting") {
	    		if (typeof ant.action != "undefined") {
		    		anthill.activities_done[ant.action] --;
			    	document.getElementById('nb-' + ant.action + '-ants').innerHTML = anthill.activities_done[ant.action];
			    }

	    		anthill.activities_done['collecting'] ++;
	    		document.getElementById('nb-collecting-ants').innerHTML = anthill.activities_done['collecting'];
	    	}
	    	ant.action = "collecting";
	    }

	    function findResourceToCollect() {
	    	var posibleResources = new Array;
	    	for (var i = 0 ; i < anthill.found_resources.length ; i ++) {
	    		if (anthill.found_resources[i].life > 0)
	    			posibleResources.push(anthill.found_resources[i]);
	    	}

	    	if (posibleResources.length == 0)
	    		return false;
	    	else
	    		return posibleResources[Math.ceil(Math.random() * (posibleResources.length - 1))];
	    }

	    function saveResource(x, y) {
	    	x = Math.ceil(x);
	    	y = Math.ceil(y);
	    	var resource = initResource(x, y)
			anthill.found_resources.push(resource);
	    }

	    function initResource(x, y) {
	    	var resource = new createjs.Shape();
	    	resource.life = Math.ceil(Math.random() * 50);
	    	resource.x = x;
	    	resource.y = y;
	    	resource.graphics.beginFill("#F00").drawCircle(0, 0, resource.life/2);
	    	stage.addChild(resource);
	    	return resource;
	    }

	    function stopCollecting(ant) {
	    	startWaiting(ant);
	    }

	    function startWaiting(ant) {
	    	if (typeof ant.action != "undefined") {
	    		anthill.activities_done[ant.action] --;
	    		document.getElementById('nb-' + ant.action + '-ants').innerHTML = anthill.activities_done[ant.action];
	    	}

	    	ant.xT = anthill.x;
	    	ant.yT = anthill.y;
	    	anthill.activities_done['waiting'] ++;
	    	document.getElementById('nb-waiting-ants').innerHTML = anthill.activities_done['waiting'];
	    	ant.action = "waiting";
	    }

	    function moveToTarget(ant, targetX, targetY) {
			if (ant.x < targetX) ant.x += 1;
			else if (ant.x > targetX) ant.x -= 1;

			else if (ant.y < targetY) ant.y += 1;
			else if (ant.y > targetY) ant.y -= 1;
	    }

	    function startExploring(ant) {
	    	if (typeof ant.action != "undefined") {
		    	anthill.activities_done[ant.action] --;
			    document.getElementById('nb-' + ant.action + '-ants').innerHTML = anthill.activities_done[ant.action];
			}
			ant.wait_before_finding_resource = 500;
	    	ant.x = Math.ceil(ant.x);
	    	ant.y = Math.ceil(ant.y);
	    	ant.action = "exploring";
	    	anthill.activities_done['exploring'] ++;
	    	document.getElementById('nb-exploring-ants').innerHTML = anthill.activities_done['exploring'];

	    }

	    function hasWaitingAnt() {
	    	return hasAntOfActivity('waiting');
	    }

	    function hasExploringAnt() {
	    	return hasAntOfActivity('exploring');
	    }

	    function hasCollectingAnt() {
	    	return hasAntOfActivity('collecting');
	    }

	    function hasAntOfActivity(activity) {
	    	return anthill.activities_done[activity] > 0;
	    }

	    function getWaitingAnt() {
	    	return getAntOfActivity('waiting');
	    }

	    function getExploringAnt() {
	    	return getAntOfActivity('exploring');
	    }

	    function getCollectingAnt() {
	    	return getAntOfActivity('collecting');
	    }

	    function getAntOfActivity(activity) {
	    	for (var i = 0; i < anthill.ants.length ; i ++) {
	    		if (anthill.ants[i].action == activity)
	    			return anthill.ants[i];
	    	}
	    }

	    setInterval(decreaseFood, 2000);
	    setInterval(starvingCheck, 10000);

	    function starvingCheck() {
	    	if (isStarving()) {
	    		decreasePopulation();
	    	}
	    }

	    function decreaseFood() {
	    	var difficulty = 0.1 + (0.05 / Math.floor(anthill.ants.length) / anthill.nb_ants_max);
	    	anthill.food_stock -= Math.floor(anthill.ants.length * difficulty);

	    	if (anthill.food_stock < 0) {
	    		anthill.food_stock = 0;
	    	}
	    	document.getElementById('food-stock').innerHTML = anthill.food_stock + ' / ' + anthill.max_food_stock;
	    }

	    function isStarving() {
	    	return anthill.food_stock <= 0;
	    }

	    function decreasePopulation() {
	    	if (anthill.ants.length > 1) {
		    	for (var i = 0 ; i < (Math.ceil(anthill.ants.length / 10)) ; i ++) {
		    		killAnt(anthill.ants[i], i);
		    		anthill.food_stock ++;
		    		document.getElementById('food-stock').innerHTML = anthill.food_stock + ' / ' + anthill.max_food_stock;
		    	}
		    }
	    }

	    function killAnt(ant, positionInAnthill) {
	    	anthill.activities_done[ant.action] --;
	    	document.getElementById('nb-' + ant.action + '-ants').innerHTML = anthill.activities_done[ant.action];

	    	anthill.ants.splice(positionInAnthill, 1);
	    	stage.removeChild(ant);
	    	document.getElementById('nb-ants').innerHTML = anthill.ants.length;
	    }

	    /* MANAGEMENT PANEL */
	    document.getElementById('start-exploring').addEventListener("click", function() {
	    	for (var i = 0 ; i < anthill.ants.length ; i ++) {
	    		if (anthill.ants[i].action != "exploring") {
	    			startExploring(anthill.ants[i]);
	    		}
	    	}

	    	document.getElementById('nb-waiting-ants').innerHTML = 0;
	    	document.getElementById('nb-collecting-ants').innerHTML = 0;
	    });

	    document.getElementById('start-collecting').addEventListener("click", function() {
	    	for (var i = 0 ; i < anthill.ants.length ; i ++) {
	    		if (anthill.ants[i].action != "collecting") {
	    			startCollecting(anthill.ants[i]);
	    		}
	    	}

	    	document.getElementById('nb-waiting-ants').innerHTML = 0;
	    	document.getElementById('nb-exploring-ants').innerHTML = 0;
	    });

	    document.getElementById('start-waiting').addEventListener("click", function() {
	    	for (var i = 0 ; i < anthill.ants.length ; i ++) {
	    		if (anthill.ants[i].action != "waiting") {
	    			startWaiting(anthill.ants[i]);
	    		}
	    	}

	    	document.getElementById('nb-exploring-ants').innerHTML = 0;
	    	document.getElementById('nb-collecting-ants').innerHTML = 0;
	    });

	    document.getElementById('add-exploring-ant').addEventListener("click", function() {
	    	if (hasWaitingAnt()) {
		    	var ant = getWaitingAnt();
		    	if (typeof ant != "undefined") {
		    		startExploring(ant);
		    	}
		    }
	    });

	    document.getElementById('remove-exploring-ant').addEventListener("click", function() {
	    	if (hasExploringAnt()) {
		    	var ant = getExploringAnt();
		    	if (typeof ant != "undefined") {
		    		startWaiting(ant);
		    	}
		    }
	    });

	    document.getElementById('add-collecting-ant').addEventListener("click", function() {
	    	if (hasWaitingAnt()) {
		    	var ant = getWaitingAnt();
		    	if (typeof ant != "undefined") {
		    		startCollecting(ant);
		    	}
		    }
	    });

	    document.getElementById('remove-collecting-ant').addEventListener("click", function() {
	    	if (hasCollectingAnt()) {
		    	var ant = getCollectingAnt();
		    	if (typeof ant != "undefined") {
		    		startWaiting(ant);
		    	}
		    }
	    });
	</script>

</body>
</html>